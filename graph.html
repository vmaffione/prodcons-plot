<!doctype html>
<html>

    <head>
        <title> ProdCon plots </title>
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script type="text/javascript">

// An object containing all the "global" variables.
var g;

// Load the Visualization API and the piechart package.
google.load('visualization', '1', {'packages':['corechart']});

// Set a callback to run when the Google Visualization API is loaded.
google.setOnLoadCallback(googleAPILoaded);

function resize(x)
{
    x.W = x.chartdiv.width = x.chartdiv.parentNode.clientWidth;
    x.H = x.chartdiv.height = x.chartdiv.parentNode.clientHeight;
    x.cx = x.W/2;
    x.cy = x.H/2;
}

function T_GP(p)
{
    if (p.Wp > p.Wc) {
        return p.Wp;
    }

    return p.Wc;
}

function T_GX(p)
{
    if (p.Sc + p.Wc > (p.L - p.Kp) * p.Wp &&
            p.Sp + p.Wp > (p.L - p.Kc) * p.Wc) {
        // Slow consumer and producer startup --> Short queue regime (SS)
        return (p.Kp * p.Wp + p.Kc * p.Wc + p.Np + p.Nc + p.Sp + p.Sc)/p.L
    }

    if (p.Wp == p.Wc) {
        return p.Wc;
    }

    if (p.Wc < p.Wp) {
        // Fast consumer

        if (p.Sc + p.Wc > (p.L - p.Kp) * p.Wp) {
            // Slow consumer startup --> Short queue regime (SC)
            m = Math.floor(((p.L - p.Kc)*p.Wc - (p.Sp + p.Wp))/(p.Wp - p.Wc)) + 1;

            //TODO
            return p.Wp + p.Np / m;
        }

        // No short queue effects (G1)
        m = Math.floor((p.Sc + (p.Kp - 1) * p.Wc)/(p.Wp - p.Wc)) + p.Kp;

        return p.Wp + p.Np / m;
    }

    // Fast producer

    if (p.Sp + p.Wp > (p.L - p.Kc) * p.Wc) {
        // Slow producer startup --> Short queue regime (SP)
        m = Math.floor(((p.L - p.Kp)*p.Wp - (p.Sc + p.Wc))/(p.Wc - p.Wp)) + 1;

        // TODO
        return p.Wc + p.Nc / m;
    }

    // No short queue effects (G2)
    m = Math.floor((p.Sp + (p.Kc - 1) * p.Wp)/(p.Wc - p.Wp)) + p.Kc;

    return p.Wc + p.Nc / m;
}

function get_int_val(pname)
{
    return parseInt(document.getElementById(pname).value);
}

// Global prototype.
function Global()
{
    // Grab the 'canvas' element.
    this.chartdiv = document.getElementById('curve_chart');
    //resize(this);
    this.chart = new google.visualization.LineChart(this.chartdiv);

    var options = {
      title: 'Time between two messages',
      curveType: 'none',
      legend: { position: 'top' }
    };

    this.params = {};
    this.update = update;
    this.update();

    function update() {
        var new_params = {};

        new_params.Wp = get_int_val('Wp');
        new_params.Wc = get_int_val('Wc');
        new_params.Sp = get_int_val('Sp');
        new_params.Sc = get_int_val('Sc');
        new_params.Np = get_int_val('Np');
        new_params.Nc = get_int_val('Nc');
        new_params.Kp = get_int_val('Kp');
        new_params.Kc = get_int_val('Kc');
        new_params.L = get_int_val('L');

        if (new_params.Wp == this.params.Wp &&
                new_params.Wc == this.params.Wc &&
                new_params.Sp == this.params.Sp &&
                new_params.Sc == this.params.Sc &&
                new_params.Np == this.params.Np &&
                new_params.Nc == this.params.Nc &&
                new_params.Kp == this.params.Kp &&
                new_params.Kc == this.params.Kc &&
                new_params.L == this.params.L) {
            return;
        }
        this.params = new_params;

        var data_array = [['W_P', 'T_GP', 'T_Gx']];
        var save_Wp = this.params.Wp;

        for (var i=1; i<4*this.params.Wc; i++) {
            this.params.Wp = i-1;
            data_array[i] = [
                this.params.Wp,
                T_GP(this.params),
                T_GX(this.params)
            ];
        }
        var data = google.visualization.arrayToDataTable(data_array);
        this.chart.draw(data, options);

        this.params.Wp = save_Wp;
    }
}

// Update the plot
function paramBlur()
{
    g.update();
}

function googleAPILoaded()
{
    g = new Global();
}

// Unused
function onload()
{
}

        </script>
    </head>

    <body onload="onload()">
        <div>
            Wp <input type="text" id="Wp" value="200" onblur="paramBlur(event)"><br>
            Wc <input type="text" id="Wc" value="200" onblur="paramBlur(event)"><br>
            Sp <input type="text" id="Sp" value="500" onblur="paramBlur(event)"><br>
            Sc <input type="text" id="Sc" value="700" onblur="paramBlur(event)"><br>
            Np <input type="text" id="Np" value="1200" onblur="paramBlur(event)"><br>
            Nc <input type="text" id="Nc" value="1500" onblur="paramBlur(event)"><br>
            Kp <input type="text" id="Kp" value="1" onblur="paramBlur(event)"><br>
            Kc <input type="text" id="Kc" value="1" onblur="paramBlur(event)"><br>
            L <input type="text" id="L" value="128" onblur="paramBlur(event)"><br>
        </div>

        <div id="curve_chart" style="width: 100%; height: 600px"></div>
    </body>

</html>
